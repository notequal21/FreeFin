# Финансовое приложение для фрилансеров: Схема БД (Supabase)

## Основные сущности

### profiles (Профили пользователей)

- `id`: uuid (references auth.users) — Первичный ключ.
- `full_name`: text — Имя пользователя.
- `primary_currency`: text (USD/RUB) — Основная валюта отображения.
- `is_approved`: boolean (default: false) — Флаг доступа. Если false, доступ к данным через RLS закрыт.
- `default_exchange_rate`: numeric (default: 100) — Курс обмена по умолчанию RUB/USD (сколько рублей за доллар). Используется для конвертации сумм при создании транзакций для проектов в валюте, отличной от валюты счета. Курс сохраняется в момент создания транзакции в поле `exchange_rate`, поэтому изменение курса по умолчанию не влияет на уже созданные транзакции.

### accounts (Счета/Кошельки)

- `id`: uuid — Первичный ключ.
- `user_id`: uuid — Владелец.
- `name`: text — Название (напр. "Тинькофф", "Payoneer").
- `currency`: text (USD/RUB) — Валюта счета.
- `balance`: decimal — Текущий остаток.

### categories (Категории)

- `id`: uuid — Первичный ключ.
- `user_id`: uuid — Приватная категория (NULL, если общая).
- `name`: text — Название категории.
- `type`: text (income/expense) — Тип.

### projects (Проекты)

- `id`: uuid — Первичный ключ.
- `user_id`: uuid — Владелец.
- `title`: text — Название проекта.
- `budget`: decimal — Бюджет проекта (NULL, если не указан).
- `currency`: text (USD/RUB) — Валюта бюджета (NULL, если бюджет не указан).
- `exchange_rate`: numeric — Курс обмена RUB/USD (сколько рублей за доллар) для проекта. Используется для конвертации сумм транзакций в валюту проекта. Если не указан, используется курс по умолчанию из профиля пользователя (`default_exchange_rate`).
- `counterparty_id`: uuid — Ссылка на контрагента (NULL, если контрагент не указан).
- `is_completed`: boolean (default: false) — Флаг завершения проекта. Если true, проект считается завершенным и не отображается в списке активных проектов.
- `created_at`: timestamp — Дата и время создания проекта.

### counterparties (Контрагенты)

- `id`: uuid — Первичный ключ.
- `user_id`: uuid — Владелец.
- `name`: text — Название контрагента.
- `type`: text (client/contractor) — Тип контрагента.
- `created_at`: timestamp — Дата и время создания контрагента.

### transactions (Транзакции)

- `id`: uuid — Первичный ключ.
- `user_id`: uuid — Владелец.
- `account_id`: uuid — Ссылка на счет.
- `category_id`: uuid — Ссылка на категорию (NULL, если категория не указана).
- `project_id`: uuid — Ссылка на проект (NULL, если проект не указан).
- `counterparty_id`: uuid — Ссылка на контрагента (NULL, если контрагент не указан).
- `amount`: decimal — Сумма в валюте транзакции (если `exchange_rate !== 1`, то валюта транзакции отличается от валюты счета).
- `exchange_rate`: decimal — Курс обмена от валюты транзакции к валюте счета (`primary_currency`) на момент транзакции (по умолчанию 1).
- `converted_amount`: decimal — Сумма в валюте счета (`primary_currency`) (вычисляется триггером `amount * exchange_rate`).
- `project_exchange_rate`: decimal — Курс обмена от `primary_currency` к валюте проекта на момент создания транзакции. Сохраняется только для транзакций, связанных с проектом, если валюта проекта отличается от валюты счета и от `primary_currency`. Используется в статистике проекта для предотвращения пересчета старых транзакций при изменении курса по умолчанию.
- `type`: text (income/expense/withdrawal) — Тип операции.
- `tags`: text[] — Массив тегов (напр. ['проект_X', 'срочно']).
- `description`: text — Комментарий.
- `is_scheduled`: boolean (default: false) — Флаг запланированной транзакции. Если true, транзакция является запланированной и требует ручного подтверждения.
- `scheduled_date`: date — Дата платежа для запланированной транзакции. Пока используется только в информационных целях, без функционала автоматического подтверждения.
- `created_at`: timestamp — Дата и время создания транзакции.

## Важная бизнес-логика

1. **Безопасность (RLS)**: Все запросы проверяют `is_approved = true` в профиле пользователя.
2. **Конвертация**: Поле `converted_amount` никогда не заполняется фронтендом. Его вычисляет PostgreSQL триггер (`amount * exchange_rate`).
3. **Автоматизация**: Профиль создается автоматически при регистрации через Auth Trigger.

## Row Level Security (RLS) Политики

### profiles (Профили)

RLS включен для всех операций. Политики:

- **INSERT**: Пользователь может создавать свой собственный профиль (`auth.uid() = id`). Это необходимо для регистрации, когда `is_approved` еще `false`.
- **SELECT**: Пользователь может читать свой профиль (`auth.uid() = id`), даже если `is_approved = false`.
- **UPDATE**: Пользователь может обновлять свой профиль (`auth.uid() = id`).

### accounts, transactions, projects, counterparties

RLS включен для всех операций. Политики:

- **ALL (SELECT, INSERT, UPDATE, DELETE)**: Доступ разрешен только если:
  - Пользователь одобрен: `profiles.is_approved = true`
  - Пользователь является владельцем: `user_id = auth.uid()`

### categories (Категории)

RLS включен для всех операций. Политики:

- **SELECT**: Пользователь может видеть:
  - Общие категории (`user_id IS NULL`) — доступны всем одобренным пользователям
  - Приватные категории (`user_id = auth.uid()`) — только свои, если пользователь одобрен
- **INSERT, UPDATE, DELETE**: Пользователь может управлять только своими категориями (`user_id = auth.uid()`) и только если одобрен.

## Триггеры и Функции

### handle_new_user()

**Триггер**: `on_auth_user_created`  
**Событие**: `AFTER INSERT ON auth.users`  
**Функция**: `SECURITY DEFINER` (обходит RLS при создании профиля)

Автоматически создает профиль при регистрации нового пользователя. Функция выполняется с правами создателя функции, поэтому RLS политики не применяются к операции вставки.

**Параметры создаваемого профиля:**

- `id` = `auth.users.id`
- `full_name` = из `raw_user_meta_data` (если есть, иначе пустая строка)
- `primary_currency` = из `raw_user_meta_data` или `'RUB'` по умолчанию
- `is_approved` = `false` (явно устанавливается при создании)

**Важно:**

- Использует `ON CONFLICT DO NOTHING` для предотвращения ошибок при повторных попытках создания.
- Метаданные могут быть недоступны в момент срабатывания триггера, поэтому `full_name` может быть пустым при создании профиля.
- Код регистрации гарантированно обновляет `full_name` после создания профиля, даже если триггер создал профиль с пустым значением.
- Если триггер не сработал, приложение создает профиль вручную через клиентский код с проверкой RLS политики.

### calculate_converted_amount()

**Триггер**: `calculate_converted_amount`  
**Событие**: `BEFORE INSERT OR UPDATE OF amount, exchange_rate ON transactions`

Автоматически вычисляет `converted_amount` при создании или обновлении транзакции:

- При **INSERT**: `converted_amount` = `amount * exchange_rate` (всегда пересчитывается)
- При **UPDATE**:
  - Если изменился `amount`, пересчитывается `converted_amount` = `amount * exchange_rate`
  - Если изменился только `exchange_rate`, сохраняется старое значение `converted_amount`
  - Это фиксирует конвертированную сумму в момент создания транзакции, предотвращая пересчет старых транзакций при изменении курса обмена

**Важно**:

- Поле `converted_amount` никогда не должно заполняться вручную на фронтенде. Его вычисляет только этот триггер.
- При обновлении курса обмена (`exchange_rate`) для существующей транзакции `converted_amount` не пересчитывается, сохраняя историческую точность данных.

### update_account_balance()

**Триггер**: `update_account_balance`  
**Событие**: `AFTER INSERT OR UPDATE OF amount, exchange_rate, type, account_id, is_scheduled OR DELETE ON transactions`

**Важно**: Триггер срабатывает при изменении `exchange_rate`, так как это пересчитывает `converted_amount`, что влияет на баланс счета. Также срабатывает при изменении `is_scheduled`, чтобы пересчитать баланс при подтверждении запланированной транзакции.

Автоматически пересчитывает баланс счета при создании, изменении или удалении транзакций:

- **income**: увеличивает баланс на `converted_amount` (сумма в валюте счета)
- **expense**: уменьшает баланс на `converted_amount` (сумма в валюте счета)
- **withdrawal**: уменьшает баланс на `converted_amount` (сумма в валюте счета)

**Важно**:

- Триггер использует `converted_amount` (сумма в валюте счета), а не `amount` (сумма в валюте транзакции). Это позволяет корректно учитывать транзакции в разных валютах.
- **Запланированные транзакции (`is_scheduled = true`) НЕ учитываются при расчете баланса счета**. Они отображаются в списке транзакций, но не влияют на баланс до момента подтверждения (когда `is_scheduled` меняется на `false`).

**Логика работы:**

1. При **INSERT** транзакции: пересчитывается баланс счета, указанного в `account_id` (только если `is_scheduled = false`)
2. При **UPDATE** транзакции:
   - Пересчитывается баланс нового счета (если `account_id` изменился)
   - Пересчитывается баланс старого счета (если `account_id` изменился)
   - Пересчитывается баланс текущего счета (если изменились `amount`, `type` или `is_scheduled`)
3. При **DELETE** транзакции: пересчитывается баланс счета, с которого была удалена транзакция (только если транзакция была подтверждена, т.е. `is_scheduled = false`)

**Важно**:

- Поле `balance` в таблице `accounts` никогда не должно обновляться вручную на фронтенде. Его вычисляет только этот триггер.
- Баланс всегда пересчитывается на основе всех **подтвержденных** транзакций счета (`is_scheduled = false`), что гарантирует его актуальность даже при изменении или удалении старых транзакций.
- При подтверждении запланированной транзакции (изменение `is_scheduled` с `true` на `false`) баланс счета автоматически пересчитывается с учетом этой транзакции.

### update_user_full_name()

**Функция**: `public.update_user_full_name(user_id uuid, new_full_name text)`  
**Тип**: `SECURITY DEFINER` (обходит RLS)  
**Доступ**: `authenticated` пользователи

Обновляет `full_name` в профиле пользователя, обходя RLS благодаря `SECURITY DEFINER`. Используется в коде регистрации для гарантированного обновления `full_name` после создания профиля.

**Параметры:**

- `user_id`: UUID пользователя (должен совпадать с `auth.uid()`)
- `new_full_name`: Новое значение ФИО

**Логика:**

- Проверяет, что пользователь обновляет только свой собственный профиль
- Обновляет `full_name` и `updated_at` в существующем профиле
- Если профиль не существует, создает его с указанным `full_name`, `primary_currency = 'RUB'` и `is_approved = false`

**Важно:**

- Функция используется в коде регистрации через RPC вызов для надежного обновления `full_name`
- Если обычный UPDATE/INSERT не работает из-за RLS (например, при email confirmation), функция гарантированно обновит профиль
